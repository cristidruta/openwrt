#include <unistd.h>
#include<stdio.h>  
#include<stdlib.h>  
#include<errno.h>  
#include<string.h>  
#include<netdb.h>  
#include<sys/types.h>  
#include<netinet/in.h>  
#include<sys/socket.h>  

#define SERVPORT 6668
#define MAXDATASIZE 500  
  
int fill_send_cmd_buf(char *buf, int type)
{
    int len=0;

    char cmd_on[]={0x00,0x00,0x55,0xAA,0x00,0x00,0x00,0x01, 0x00,0x00,0x00,0x07,0x00,0x00,0x00,0xA8,
                   0x65,0x39,0x64,0x37,0x37,0x65,0x31,0x62, 0x32,0x64,0x63,0x66,0x62,0x66,0x32,0x63,
                   0x37,0x33,0x31,0x31,0x34,0x62,0x33,0x38, 0x37,0x33,0x64,0x39,0x32,0x66,0x38,0x63,
                   0x62,0x37,0x33,0x35,0x36,0x65,0x30,0x33, 0x32,0x33,0x34,0x62,0x62,0x32,0x31,0x30,
                   0x62,0x39,0x31,0x35,0x63,0x32,0x64,0x37, 0x63,0x37,0x39,0x66,0x37,0x37,0x61,0x63,
                   0x64,0x33,0x31,0x31,0x38,0x38,0x35,0x39, 0x33,0x35,0x30,0x64,0x65,0x39,0x66,0x32,
                   0x31,0x63,0x37,0x32,0x38,0x63,0x39,0x38, 0x63,0x36,0x36,0x62,0x33,0x62,0x32,0x37,
                   0x32,0x34,0x66,0x31,0x34,0x63,0x64,0x37, 0x63,0x36,0x39,0x36,0x65,0x66,0x36,0x36,
                   0x33,0x32,0x36,0x64,0x62,0x66,0x30,0x32, 0x63,0x36,0x30,0x32,0x38,0x37,0x37,0x33,
                   0x64,0x62,0x62,0x30,0x64,0x38,0x35,0x39, 0x32,0x36,0x35,0x33,0x34,0x36,0x61,0x35,
                   0x37,0x35,0x38,0x61,0x36,0x39,0x38,0x30, 0x34,0x30,0x64,0x31,0x36,0x33,0x64,0x31,
                   0x73,0x1B,0x2E,0x3C,0x00,0x00,0xAA,0x55};

    char cmd_off[]={0x00,0x00,0x55,0xAA,0x00,0x00,0x00,0x01, 0x00,0x00,0x00,0x07,0x00,0x00,0x00,0xA8,
                    0x65,0x39,0x64,0x37,0x37,0x65,0x31,0x62, 0x32,0x64,0x63,0x66,0x62,0x66,0x32,0x63,
                    0x37,0x33,0x31,0x31,0x34,0x62,0x33,0x38, 0x37,0x33,0x64,0x39,0x32,0x66,0x38,0x63,
                    0x62,0x37,0x33,0x35,0x36,0x65,0x30,0x33, 0x32,0x33,0x34,0x62,0x62,0x32,0x31,0x30,
                    0x62,0x39,0x31,0x35,0x63,0x32,0x64,0x37, 0x63,0x37,0x39,0x66,0x37,0x37,0x61,0x63,
                    0x64,0x33,0x31,0x31,0x38,0x38,0x35,0x39, 0x33,0x35,0x30,0x64,0x65,0x39,0x66,0x32,
                    0x31,0x63,0x37,0x32,0x38,0x63,0x39,0x38, 0x63,0x36,0x36,0x62,0x33,0x62,0x32,0x37,
                    0x32,0x34,0x66,0x31,0x34,0x63,0x64,0x37, 0x63,0x36,0x39,0x36,0x65,0x66,0x36,0x36,
                    0x33,0x32,0x36,0x64,0x62,0x66,0x30,0x32, 0x63,0x36,0x30,0x32,0x38,0x37,0x37,0x33,
                    0x35,0x37,0x65,0x30,0x33,0x36,0x33,0x32, 0x63,0x36,0x61,0x39,0x36,0x63,0x61,0x61,
                    0x34,0x30,0x66,0x61,0x61,0x34,0x64,0x35, 0x38,0x64,0x33,0x63,0x30,0x62,0x64,0x33,
                    0x07,0x39,0xb6,0xfd,0x00,0x00,0xaa,0x55};
    if(type==1) {
        len = sizeof(cmd_on);
        memcpy(buf, cmd_on, len);
    } else if(type==0) {
        len = sizeof(cmd_off);
        memcpy(buf, cmd_off, len);
    }

    return len;
}

int main(int argc,char *argv[]){  
   int sockfd,recvbytes;  
   char buf[MAXDATASIZE];  
   struct hostent *host;  
   struct sockaddr_in serv_addr;  
   
   char cmd_buf[MAXDATASIZE];
   int cmd_len=0,cmd_type=-1;
   int send_bytes=0;
   

   if(argc<3){  
     fprintf(stderr,"usage: tuyaled_cmd [led's ip address] [0/1]\r\n");
     fprintf(stderr,"          0: led off\r\n");
     fprintf(stderr,"          1: led on\r\n");
     exit(1);  
   }

   cmd_type = atoi(argv[2]);
   cmd_len = fill_send_cmd_buf(cmd_buf, cmd_type);

   if(cmd_len == 0) {
     fprintf(stderr,"cmd type is wrong!\r\n");
     fprintf(stderr,"usage: tuyaled_cmd [led's ip address] [0/1]\r\n");
     fprintf(stderr,"          0: led off\r\n");
     fprintf(stderr,"          1: led on\r\n");
   }

   if((host=gethostbyname(argv[1]))==NULL){
     fprintf(stderr,"led's hostname or ip can not be accessed!\r\n");
     fprintf(stderr,"usage: tuyaled_cmd [led's ip address] [0/1]\r\n");
     fprintf(stderr,"          0: led off\r\n");
     fprintf(stderr,"          1: led on\r\n");
     exit(1);
   }

   if((sockfd=socket(AF_INET,SOCK_STREAM,0))==-1){
     perror("socket create error!");
     exit(1);
   }
   serv_addr.sin_family=AF_INET;
   serv_addr.sin_port=htons(SERVPORT);
   serv_addr.sin_addr = *((struct in_addr *)host->h_addr);
   bzero(&(serv_addr.sin_zero),8);

   if(connect(sockfd,(struct sockaddr *)&serv_addr,sizeof(struct sockaddr))==-1){
     perror("connect error1!");
     exit(1);
   }

   if((send_bytes=send(sockfd, cmd_buf, cmd_len, 0))==-1){
       if(send_bytes != cmd_len) {
           printf("send Error!\r\n");
       }
       else {
           printf("send OK!\r\n");
       }
   }

   if((recvbytes=recv(sockfd,buf,MAXDATASIZE,0))==-1){
     perror("connect error2!");
     exit(1);
   }
   buf[recvbytes]='\0';
   printf("receive: %s",buf);
   close(sockfd);

   return 0;
}
